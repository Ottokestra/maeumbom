<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마음봄 Agent V2</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="agent.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            🌸 마음봄 Agent V2
        </div>
        <button class="mood-check-btn" id="moodCheckBtn" onclick="openDailyMoodCheckModal()">
            <span id="moodCheckIcon">💭</span> 일일 기분 체크
        </button>
        <button class="mood-check-btn" onclick="location.href='dashboard.html'"
            style="margin-top: 10px; background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb;">
            <span>📊</span> 감정 대시보드
        </button>
        <button class="new-chat-btn" onclick="createNewSession()">
            <span>+</span> 새로운 대화
        </button>
        <div class="session-list" id="sessionList">
            <!-- Sessions will be loaded here -->
        </div>
        <div class="sidebar-footer">
            <div class="auth-status">
                <div class="status-dot" id="authDot"></div>
                <span id="authText">인증 필요</span>
                <button class="token-btn" onclick="openSettingsModal()">설정</button>
            </div>
        </div>
    </div>

    <div class="mood-modal" id="moodModal">
        <div class="mood-modal-content">
            <div class="mood-modal-header">
                <h3>💭 일일 기분 체크</h3>
                <button class="mood-close-btn" onclick="closeDailyMoodCheckModal()">×</button>
            </div>

            <div class="mood-status-message" id="moodStatusMessage">
                오늘의 감정을 선택 해주세요.
            </div>

            <div class="mood-images-grid" id="moodImagesGrid">
                <!-- Images will be loaded here dynamically -->
            </div>

            <div class="mood-confirmation" id="moodConfirmation" style="display: none;">
                <p style="font-size: 1rem; color: #666; margin-bottom: 15px;">
                    오늘의 기분을 선택하신 사진으로 변경할까요?
                </p>
                <div class="mood-confirmation-buttons">
                    <button class="mood-confirm-btn" onclick="confirmMoodChange()">확인</button>
                    <button class="mood-cancel-btn" onclick="cancelMoodChange()">취소</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="chat-header">
            <h3 id="currentSessionTitle">새로운 대화</h3>
            <div style="font-size: 0.8rem; color: #888;">
                DB 저장됨 • JWT 인증
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-bubble">
                    안녕하세요! 저는 당신의 마음을 돌보는 AI 상담사 봄이입니다. 오늘 하루는 어떠셨나요?
                </div>
                <div class="message-time">방금 전</div>
            </div>
        </div>

        <div class="input-area">
            <button class="mic-btn" id="micBtn" onclick="toggleRecording()">
                🎤
            </button>
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="메시지를 입력하세요..." onkeydown="handleEnter(event)"></textarea>
            </div>
            <button class="send-btn" onclick="sendMessage()">
                ➤
            </button>
        </div>

        <!-- Debug Pipeline UI -->
        <div class="pipeline-section" id="pipelineSection">
            <div class="pipeline-title" onclick="togglePipeline()">
                <span>🛠️ 처리 파이프라인 상태</span>
                <span id="pipelineToggleIcon">▼</span>
            </div>

            <div id="pipelineContent">
                <!-- Emotion Analysis -->
                <div class="tool-card pending" id="emotionCard">
                    <div class="tool-header">
                        <div class="tool-name">😊 감정 분석</div>
                        <div class="tool-status" id="emotionStatus">대기 중</div>
                    </div>
                    <div class="tool-content" id="emotionContent"></div>
                </div>

                <!-- Routine Recommendation -->
                <div class="tool-card pending" id="routineCard">
                    <div class="tool-header">
                        <div class="tool-name">📅 루틴 추천</div>
                        <div class="tool-status" id="routineStatus">대기 중</div>
                    </div>
                    <div class="tool-content" id="routineContent"></div>
                </div>

                <!-- LLM Generation -->
                <div class="tool-card pending" id="llmCard">
                    <div class="tool-header">
                        <div class="tool-name">🤖 답변 생성</div>
                        <div class="tool-status" id="llmStatus">대기 중</div>
                    </div>
                    <div class="tool-content" id="llmContent"></div>
                </div>

                <!-- TTS Generation -->
                <div class="tool-card pending" id="ttsCard">
                    <div class="tool-header">
                        <div class="tool-name">🔊 음성 합성</div>
                        <div class="tool-status" id="ttsStatus">대기 중</div>
                    </div>
                    <div class="tool-content" id="ttsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>⚙️ 설정</h3>

            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #555;">🔐 인증 설정</h4>
                <p style="font-size: 0.85rem; color: #888; margin-bottom: 10px;">
                    Google OAuth (/auth/google) 로그인 후 발급받은 Access Token을 입력해주세요.
                </p>
                <input type="text" id="jwtInput" placeholder="Bearer Token">
                <div style="text-align: right;">
                    <button class="new-chat-btn" style="margin: 0; padding: 6px 15px; font-size: 0.85rem;"
                        onclick="saveToken()">토큰 저장</button>
                </div>
            </div>

            <div style="border-top: 1px solid #eee; padding-top: 20px;">
                <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #555;">데이터 관리 (테스트용)</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="token-btn" style="color: #d32f2f; border-color: #d32f2f;" onclick="cleanupHistory()">
                        🗑️ 대화 내역 초기화 (DB + RAG)
                    </button>
                    <button class="token-btn" style="color: #d32f2f; border-color: #d32f2f;"
                        onclick="cleanupMemories()">
                        🧠 기억 초기화 (단기 + 장기)
                    </button>
                </div>
            </div>
            <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #555;">일일 기분 체크 관리 (테스트용)</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="token-btn" style="color: #d32f2f; border-color: #d32f2f;"
                        onclick="cleanupMoodSelections()">
                        🗑️ 기분 체크 기록 초기화
                    </button>
                    <button class="token-btn" style="color: #d32f2f; border-color: #d32f2f;"
                        onclick="cleanupMoodEmotionAnalysis()">
                        🧠 기분 분석 데이터 초기화
                    </button>
                </div>
            </div>
            <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #555;">대화 관련 감정 관리 (테스트용)</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="token-btn" style="color: #d32f2f; border-color: #d32f2f;"
                        onclick="resetConversationEmotionData()">
                        🧠 대화 감정 데이터 초기화
                    </button>
                </div>
            </div>

            <div class="modal-buttons" style="margin-top: 25px;">
                <button class="token-btn" onclick="closeSettingsModal()">닫기</button>
            </div>
        </div>
    </div>

    <script src="agent.js"></script>
</body>

</html>