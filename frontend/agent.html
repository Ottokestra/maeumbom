<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆìŒë´„ - LangChain Agent í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }

        .input-section textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s;
        }

        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .pipeline-section {
            margin-top: 30px;
        }

        .pipeline-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tool-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .tool-card.processing {
            border-left-color: #ffa726;
            animation: pulse 1.5s infinite;
        }

        .tool-card.success {
            border-left-color: #66bb6a;
        }

        .tool-card.error {
            border-left-color: #ef5350;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .tool-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .tool-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-time {
            font-size: 0.75rem;
            color: #999;
            font-weight: normal;
        }

        .status-pending {
            background: #e0e0e0;
            color: #666;
        }

        .status-processing {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
        }

        .tool-content {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .tool-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .emotion-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .emotion-item.primary {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }

        .emotion-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .emotion-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .emotion-intensity {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .intensity-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
        }

        .intensity-dot.active {
            background: #667eea;
        }

        .ai-response {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }

        .ai-response-label {
            font-size: 0.9rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .ai-response-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .icon {
            font-size: 1.3rem;
        }

        .meta-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        .meta-item strong {
            color: #333;
        }

        /* ë§ˆì´í¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-mic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-mic:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-mic:active {
            transform: scale(0.95);
        }

        .btn-mic.recording {
            background: linear-gradient(135deg, #ef5350 0%, #e91e63 100%);
            animation: pulse-mic 1.5s infinite;
        }

        @keyframes pulse-mic {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(239, 83, 80, 0.3);
            }
            50% {
                box-shadow: 0 10px 50px rgba(239, 83, 80, 0.6), 0 0 0 15px rgba(239, 83, 80, 0.1);
            }
        }

        .mic-icon {
            display: inline-block;
            transition: transform 0.3s;
        }

        .btn-mic.recording .mic-icon {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¸ ë§ˆìŒë´„ - LangChain Agent</h1>
            <p>STT â†’ ê°ì • ë¶„ì„ â†’ AI ì‘ë‹µ ìƒì„± íŒŒì´í”„ë¼ì¸</p>
        </div>

        <div class="main-card">
            <div class="input-section">
                <label>ì…ë ¥ ë°©ì‹ ì„ íƒ</label>
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="inputMode" value="text" checked onchange="switchInputMode('text')">
                        <span>ğŸ“ í…ìŠ¤íŠ¸ ì…ë ¥</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="inputMode" value="voice" onchange="switchInputMode('voice')">
                        <span>ğŸ¤ ìŒì„± ì…ë ¥</span>
                    </label>
                </div>
                
                <div id="textInputArea">
                    <label for="userInput">ì‚¬ìš©ì ì…ë ¥ (í…ìŠ¤íŠ¸)</label>
                    <textarea 
                        id="userInput"
                        placeholder="ì˜ˆ: ì˜¤ëŠ˜ í•˜ë£¨ ì •ë§ í˜ë“¤ì—ˆì–´ìš”. ì•„ë¬´ê²ƒë„ í•˜ê¸° ì‹«ê³  ê¸°ìš´ì´ ì—†ë„¤ìš”."
                    ></textarea>
                </div>
                
                <div id="voiceInputArea" style="display: none;">
                    <label>ìŒì„± ë…¹ìŒ</label>
                    <div style="text-align: center; padding: 30px;">
                        <button class="btn-mic" id="micBtn" onclick="toggleVoiceInput()">
                            <span class="mic-icon">ğŸ¤</span>
                        </button>
                        <div id="voiceStatus" style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                            ë§ˆì´í¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë…¹ìŒì„ ì‹œì‘í•˜ì„¸ìš”
                        </div>
                        <div id="recognizedText" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 10px; min-height: 60px; display: none;">
                            <div style="font-size: 0.85rem; color: #999; margin-bottom: 8px;">ì¸ì‹ëœ í…ìŠ¤íŠ¸:</div>
                            <div id="recognizedTextContent" style="font-size: 1rem; color: #333;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="runBtn" onclick="runAgent()">
                    ğŸš€ Agent ì‹¤í–‰
                </button>
                <button class="btn btn-secondary" onclick="clearResults()">
                    ğŸ”„ ì´ˆê¸°í™”
                </button>
            </div>

            <div class="pipeline-section" id="pipelineSection" style="display: none;">
                <div class="pipeline-title">ğŸ“Š ì‹¤í–‰ íŒŒì´í”„ë¼ì¸</div>

                <!-- STT Tool -->
                <div class="tool-card" id="sttCard">
                    <div class="tool-header">
                        <div class="tool-name">
                            <span class="icon">ğŸ¤</span>
                            <span>3-2. Speech-to-Text (STT)</span>
                        </div>
                        <div class="tool-status status-pending" id="sttStatus">ëŒ€ê¸° ì¤‘</div>
                    </div>
                    <div class="tool-content" id="sttContent" style="display: none;"></div>
                </div>

                <!-- Emotion Analysis Tool -->
                <div class="tool-card" id="emotionCard">
                    <div class="tool-header">
                        <div class="tool-name">
                            <span class="icon">ğŸ’­</span>
                            <span>3-4. Emotion Analysis</span>
                        </div>
                        <div class="tool-status status-pending" id="emotionStatus">ëŒ€ê¸° ì¤‘</div>
                    </div>
                    <div class="tool-content" id="emotionContent" style="display: none;"></div>
                </div>

                <!-- Routine Recommend Tool -->
                <div class="tool-card" id="routineCard">
                    <div class="tool-header">
                        <div class="tool-name">
                            <span class="icon">ğŸ“…</span>
                            <span>3-5. Routine Recommend</span>
                        </div>
                        <div class="tool-status status-pending" id="routineStatus">ëŒ€ê¸° ì¤‘</div>
                    </div>
                    <div class="tool-content" id="routineContent" style="display: none;"></div>
                </div>

                <!-- Future Tools Placeholder -->
                <div class="tool-card" style="opacity: 0.5; border-left-color: #ccc;">
                    <div class="tool-header">
                        <div class="tool-name">
                            <span class="icon">ğŸ¥</span>
                            <span>3-11. Health Advisor (ì˜ˆì •)</span>
                        </div>
                        <div class="tool-status status-pending">ì¤€ë¹„ ì¤‘</div>
                    </div>
                </div>

                <!-- LLM Response Tool -->
                <div class="tool-card" id="llmCard">
                    <div class="tool-header">
                        <div class="tool-name">
                            <span class="icon">ğŸ¤–</span>
                            <span>3-8. LLM Response (GPT-4o-mini)</span>
                        </div>
                        <div class="tool-status status-pending" id="llmStatus">ëŒ€ê¸° ì¤‘</div>
                    </div>
                    <div class="tool-content" id="llmContent" style="display: none;"></div>
                </div>

                <!-- TTS Tool -->
                <div class="tool-card" id="ttsCard">
                    <div class="tool-header">
                        <div class="tool-name">
                            <span class="icon">ğŸ”Š</span>
                            <span>3-7. Text-to-Speech (TTS)</span>
                        </div>
                        <div class="tool-status status-pending" id="ttsStatus">ëŒ€ê¸° ì¤‘</div>
                    </div>
                    <div class="tool-content" id="ttsContent" style="display: none;"></div>
                </div>

            </div>
        </div>

        <!-- Agent Memory Section -->
        <div class="main-card" id="memorySection" style="display: none;">
            <div class="pipeline-title">ğŸ’¾ Agent Memory (ëŒ€í™” íˆìŠ¤í† ë¦¬)</div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="loadMemory()" style="flex: 0 0 auto;">
                    ğŸ”„ ë©”ëª¨ë¦¬ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>

            <div id="memoryContent">
                <div style="text-align: center; padding: 40px; color: #999;">
                    ë©”ëª¨ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ "ë©”ëª¨ë¦¬ ìƒˆë¡œê³ ì¹¨" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = 'web_session_' + Date.now();
        let timers = {
            stt: { start: 0, end: 0 },
            emotion: { start: 0, end: 0 },
            routine: { start: 0, end: 0 },
            llm: { start: 0, end: 0 },
            tts: { start: 0, end: 0 }
        };

        // ìŒì„± ì…ë ¥ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
        let inputMode = 'text';  // 'text' or 'voice'
        let isRecording = false;
        let audioContext = null;
        let mediaStream = null;
        let scriptProcessor = null;
        let sttWebSocket = null;
        let recognizedFullText = '';

        // ì…ë ¥ ëª¨ë“œ ì „í™˜
        function switchInputMode(mode) {
            inputMode = mode;
            const textArea = document.getElementById('textInputArea');
            const voiceArea = document.getElementById('voiceInputArea');
            
            if (mode === 'text') {
                textArea.style.display = 'block';
                voiceArea.style.display = 'none';
                // ìŒì„± ë…¹ìŒ ì¤‘ì´ë©´ ì¤‘ì§€
                if (isRecording) {
                    stopVoiceInput();
                }
            } else {
                textArea.style.display = 'none';
                voiceArea.style.display = 'block';
            }
        }

        // ìŒì„± ì…ë ¥ í† ê¸€
        function toggleVoiceInput() {
            if (isRecording) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        // ìŒì„± ì…ë ¥ ì‹œì‘
        async function startVoiceInput() {
            try {
                // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });

                // AudioContext ìƒì„± (16kHz)
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(mediaStream);
                
                // ScriptProcessor ìƒì„± (512 ìƒ˜í”Œ ë²„í¼)
                scriptProcessor = audioContext.createScriptProcessor(512, 1, 1);
                
                // WebSocket ì—°ê²°
                sttWebSocket = new WebSocket('ws://localhost:8000/stt/stream');
                
                sttWebSocket.onopen = () => {
                    console.log('STT WebSocket ì—°ê²°ë¨');
                    updateVoiceStatus('â³ STT ì—”ì§„ ì¤€ë¹„ ì¤‘...', 'connecting');
                };
                
                sttWebSocket.onmessage = (event) => {
                    handleSTTMessage(JSON.parse(event.data));
                };
                
                sttWebSocket.onerror = (error) => {
                    console.error('WebSocket ì˜¤ë¥˜:', error);
                    updateVoiceStatus('âŒ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                    stopVoiceInput();
                };
                
                sttWebSocket.onclose = () => {
                    console.log('STT WebSocket ì—°ê²° ì¢…ë£Œ');
                };
                
                // ì˜¤ë””ì˜¤ í”„ë¡œì„¸ì‹±
                scriptProcessor.onaudioprocess = (e) => {
                    if (sttWebSocket && sttWebSocket.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const float32Array = new Float32Array(inputData);
                        sttWebSocket.send(float32Array.buffer);
                    }
                };
                
                // ì—°ê²°
                source.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                // UI ì—…ë°ì´íŠ¸
                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                recognizedFullText = '';
                document.getElementById('recognizedText').style.display = 'none';
                
            } catch (error) {
                console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                alert('ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                updateVoiceStatus('âŒ ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨', 'error');
            }
        }

        // ìŒì„± ì…ë ¥ ì¤‘ì§€
        function stopVoiceInput() {
            // WebSocket ì¢…ë£Œ ì „ ê°•ì œ ì²˜ë¦¬ ìš”ì²­
            if (sttWebSocket && sttWebSocket.readyState === WebSocket.OPEN) {
                sttWebSocket.send(JSON.stringify({ text: 'force_process' }));
                setTimeout(() => {
                    if (sttWebSocket) {
                        sttWebSocket.close();
                        sttWebSocket = null;
                    }
                }, 500);
            }
            
            // ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // UI ì—…ë°ì´íŠ¸
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');
            updateVoiceStatus('ë…¹ìŒ ì™„ë£Œ', 'success');
        }

        // STT ë©”ì‹œì§€ ì²˜ë¦¬
        function handleSTTMessage(data) {
            if (data.status === 'connecting') {
                console.log('STT ì—”ì§„ ì´ˆê¸°í™” ì¤‘:', data.message);
                updateVoiceStatus('â³ ' + data.message, 'connecting');
            } else if (data.status === 'ready') {
                console.log('STT ì—”ì§„ ì¤€ë¹„:', data.message);
                updateVoiceStatus('ğŸ¤ ë…¹ìŒ ì¤‘... ë§ì”€í•˜ì„¸ìš”', 'recording');
                
                // íŒŒì´í”„ë¼ì¸ ì„¹ì…˜ í‘œì‹œ ë° STT ì¹´ë“œ í™œì„±í™”
                document.getElementById('pipelineSection').style.display = 'block';
                timers.stt.start = performance.now();
                updateToolStatus('stt', 'processing', 'ìŒì„± ì¸ì‹ ì¤‘...');
            } else if (data.text !== undefined) {
                // STT ê²°ê³¼ ìˆ˜ì‹ 
                if (data.text && data.text.trim()) {
                    recognizedFullText = data.text;
                    document.getElementById('recognizedText').style.display = 'block';
                    document.getElementById('recognizedTextContent').textContent = data.text;
                    
                    // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì—ë„ ë°˜ì˜
                    document.getElementById('userInput').value = data.text;
                    
                    // STT ì™„ë£Œ
                    timers.stt.end = performance.now();
                    const duration = Math.round(timers.stt.end - timers.stt.start);
                    
                    // í’ˆì§ˆì— ë”°ë¼ ë‹¤ë¥¸ ìƒíƒœ í‘œì‹œ
                    if (data.quality === 'success') {
                        updateToolStatus('stt', 'success', 'ì™„ë£Œ', duration);
                    } else if (data.quality === 'medium') {
                        updateToolStatus('stt', 'success', 'ì™„ë£Œ (ë³´í†µ)', duration);
                    } else if (data.quality === 'low_quality') {
                        updateToolStatus('stt', 'success', 'ì™„ë£Œ (ë‚®ì€ í’ˆì§ˆ)', duration);
                        updateVoiceStatus('âš ï¸ ìŒì§ˆì´ ë‚®ì§€ë§Œ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤', 'warning');
                    }
                    
                    // 3-2 ì˜ì—­ì— STT ê²°ê³¼ í‘œì‹œ
                    displaySTTResult({
                        input: data.text,
                        method: 'voice_websocket',
                        note: 'Silero VAD + Faster-Whisper ê¸°ë°˜ ì‹¤ì‹œê°„ ìŒì„± ì¸ì‹',
                        duration: duration,
                        quality: data.quality
                    });
                    
                    // ìë™ìœ¼ë¡œ Agent ì‹¤í–‰ (í’ˆì§ˆ ë¬´ê´€í•˜ê²Œ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì‹¤í–‰)
                    updateVoiceStatus('âœ… ì¸ì‹ ì™„ë£Œ! Agent ì‹¤í–‰ ì¤‘...', 'success');
                    setTimeout(() => {
                        stopVoiceInput();
                        runAgent();
                    }, 500);
                } else if (data.quality === 'no_speech') {
                    console.log('ìŒì„± ë¯¸ê°ì§€');
                    updateVoiceStatus('ğŸ”‡ ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'warning');
                    timers.stt.end = performance.now();
                    const duration = Math.round(timers.stt.end - timers.stt.start);
                    updateToolStatus('stt', 'success', 'ì™„ë£Œ (ìŒì„± ë¯¸ê°ì§€)', duration);
                    
                    // ìŒì„± ë¯¸ê°ì§€ë„ 3-2 ì˜ì—­ì— í‘œì‹œ
                    displaySTTResult({
                        input: '(ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤)',
                        method: 'voice_websocket',
                        note: 'ë§ˆì´í¬ ì…ë ¥ì€ ì •ìƒì´ì§€ë§Œ ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤',
                        duration: duration,
                        quality: 'no_speech'
                    });
                }
            } else if (data.error) {
                console.error('STT ì˜¤ë¥˜:', data.error);
                updateVoiceStatus('âŒ ' + data.error, 'error');
                updateToolStatus('stt', 'error', 'ì˜¤ë¥˜');
            }
        }

        // ìŒì„± ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateVoiceStatus(message, status) {
            const statusEl = document.getElementById('voiceStatus');
            statusEl.textContent = message;
            statusEl.style.color = status === 'recording' ? '#ef5350' : 
                                   status === 'success' ? '#66bb6a' :
                                   status === 'warning' ? '#ffa726' :
                                   status === 'error' ? '#ef5350' : '#666';
        }

        async function runAgent() {
            const userInput = document.getElementById('userInput').value.trim();
            
            if (!userInput) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì´ˆê¸°í™”
            document.getElementById('pipelineSection').style.display = 'block';
            document.getElementById('runBtn').disabled = true;
            resetToolCards();

            try {
                // 1. STT ì²˜ë¦¬ (ì…ë ¥ ëª¨ë“œì— ë”°ë¼)
                if (inputMode === 'voice' && recognizedFullText) {
                    // ìŒì„± ì…ë ¥ì€ ì´ë¯¸ STT ê²°ê³¼ê°€ í‘œì‹œë˜ì–´ ìˆìŒ - ìƒëµ
                    console.log('ìŒì„± ì…ë ¥ STT ì´ë¯¸ ì™„ë£Œ:', recognizedFullText);
                } else {
                    // í…ìŠ¤íŠ¸ ì…ë ¥ - ì‹œë®¬ë ˆì´ì…˜
                    await simulateSTT(userInput);
                }

                // 2. Agent API í˜¸ì¶œ
                await callAgentAPI(userInput);

                // 3. ë©”ëª¨ë¦¬ ìë™ ë¡œë“œ
                await loadMemory();

            } catch (error) {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                document.getElementById('runBtn').disabled = false;
            }
        }

        async function simulateSTT(text) {
            timers.stt.start = performance.now();
            updateToolStatus('stt', 'processing', 'ì²˜ë¦¬ ì¤‘...');
            
            // ì‹œë®¬ë ˆì´ì…˜ ë”œë ˆì´
            await new Promise(resolve => setTimeout(resolve, 500));
            
            timers.stt.end = performance.now();
            const duration = Math.round(timers.stt.end - timers.stt.start);
            
            const sttResult = {
                input: text,
                method: 'text_dummy',
                note: 'í˜„ì¬ëŠ” í…ìŠ¤íŠ¸ ë”ë¯¸ ì…ë ¥ ë°©ì‹ (ì¶”í›„ ìŒì„± ì…ë ¥ìœ¼ë¡œ ë³€ê²½ ì˜ˆì •)',
                duration: duration
            };
            
            updateToolStatus('stt', 'success', 'ì™„ë£Œ', duration);
            displaySTTResult(sttResult);
        }

        async function callAgentAPI(text) {
            // Emotion Analysis ì‹œì‘
            timers.emotion.start = performance.now();
            updateToolStatus('emotion', 'processing', 'ë¶„ì„ ì¤‘...');
            
            // LLMë„ í•¨ê»˜ ì‹œì‘ (API í˜¸ì¶œì— í¬í•¨ë˜ë¯€ë¡œ)
            timers.llm.start = performance.now();
            
            try {
                const apiStartTime = performance.now();
                const response = await fetch('http://localhost:8000/api/agent/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_text: text,
                        session_id: currentSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const apiEndTime = performance.now();
                const totalApiTime = Math.round(apiEndTime - apiStartTime);
                
                // Emotion Analysis ì™„ë£Œ
                timers.emotion.end = apiStartTime + (totalApiTime * 0.4);
                const emotionDuration = Math.round(timers.emotion.end - timers.emotion.start);
                updateToolStatus('emotion', 'success', 'ì™„ë£Œ', emotionDuration);
                displayEmotionResult(result.emotion_result, emotionDuration);

                // Routine Recommend ì²˜ë¦¬
                if (result.routine_result && result.routine_result.length > 0) {
                    timers.routine.start = timers.emotion.end;
                    updateToolStatus('routine', 'processing', 'ì¶”ì²œ ì¤‘...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    timers.routine.end = apiStartTime + (totalApiTime * 0.7);
                    const routineDuration = Math.round(timers.routine.end - timers.routine.start);
                    updateToolStatus('routine', 'success', 'ì™„ë£Œ', routineDuration);
                    displayRoutineResult(result.routine_result, routineDuration);
                } else {
                    updateToolStatus('routine', 'success', 'ì¶”ì²œ ë¶ˆí•„ìš”');
                }

                // LLM Response ì™„ë£Œ
                updateToolStatus('llm', 'processing', 'ìƒì„± ì¤‘...');
                await new Promise(resolve => setTimeout(resolve, 100));
                timers.llm.end = apiEndTime;
                const llmDuration = Math.round(timers.llm.end - timers.llm.start);
                updateToolStatus('llm', 'success', 'ì™„ë£Œ', llmDuration);
                displayLLMResult(result, llmDuration);

                // TTS ìë™ í˜¸ì¶œ
                await callTTS(result.reply_text);

            } catch (error) {
                updateToolStatus('emotion', 'error', 'ì˜¤ë¥˜');
                updateToolStatus('routine', 'error', 'ì˜¤ë¥˜');
                updateToolStatus('llm', 'error', 'ì˜¤ë¥˜');
                updateToolStatus('tts', 'error', 'ì˜¤ë¥˜');
                throw error;
            }
        }

        function updateToolStatus(tool, status, text, duration = null) {
            const card = document.getElementById(`${tool}Card`);
            const statusEl = document.getElementById(`${tool}Status`);
            
            // ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
            card.className = 'tool-card';
            if (status === 'processing') {
                card.classList.add('processing');
            } else if (status === 'success') {
                card.classList.add('success');
            } else if (status === 'error') {
                card.classList.add('error');
            }

            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            statusEl.className = 'tool-status';
            statusEl.classList.add(`status-${status}`);
            
            // ì‹œê°„ ì •ë³´ í¬í•¨
            if (duration !== null && status === 'success') {
                statusEl.innerHTML = `
                    <span>${text}</span>
                    <span class="tool-time">(${duration}ms)</span>
                `;
            } else {
                statusEl.textContent = text;
            }
        }

        function displaySTTResult(result) {
            const content = document.getElementById('sttContent');
            content.style.display = 'block';
            content.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>ì…ë ¥ í…ìŠ¤íŠ¸:</strong>
                    <div style="margin-top: 8px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        ${result.input}
                    </div>
                </div>
                <div class="meta-info">
                    <div class="meta-item">
                        <span>ğŸ“</span>
                        <span><strong>ì…ë ¥ ë°©ì‹:</strong> ${result.method}</span>
                    </div>
                    <div class="meta-item">
                        <span>â±ï¸</span>
                        <span><strong>ì²˜ë¦¬ ì‹œê°„:</strong> ${result.duration}ms</span>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px; font-size: 0.85rem; color: #f57c00;">
                    â„¹ï¸ ${result.note}
                </div>
            `;
        }

        function displayEmotionResult(emotion, duration) {
            const content = document.getElementById('emotionContent');
            content.style.display = 'block';
            
            const primary = emotion.primary_emotion;
            const secondary = emotion.secondary_emotions || [];
            
            // ê°•ë„ í‘œì‹œ ìƒì„±
            const intensityDots = (intensity) => {
                let dots = '';
                for (let i = 1; i <= 5; i++) {
                    dots += `<div class="intensity-dot ${i <= intensity ? 'active' : ''}"></div>`;
                }
                return dots;
            };

            content.innerHTML = `
                <div class="emotion-grid">
                    <div class="emotion-item primary">
                        <div class="emotion-label">ì£¼ìš” ê°ì •</div>
                        <div class="emotion-value">${primary.name_ko}</div>
                        <div class="emotion-intensity">${intensityDots(primary.intensity)}</div>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #666;">
                            ì‹ ë¢°ë„: ${(primary.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                    
                    <div class="emotion-item">
                        <div class="emotion-label">ì „ì²´ ê°ì •</div>
                        <div class="emotion-value" style="color: ${emotion.sentiment_overall === 'positive' ? '#66bb6a' : emotion.sentiment_overall === 'negative' ? '#ef5350' : '#ffa726'}">
                            ${emotion.sentiment_overall === 'positive' ? 'ê¸ì •ì ' : emotion.sentiment_overall === 'negative' ? 'ë¶€ì •ì ' : 'ì¤‘ë¦½'}
                        </div>
                    </div>
                    
                    <div class="emotion-item">
                        <div class="emotion-label">ìœ„í—˜ ìˆ˜ì¤€</div>
                        <div class="emotion-value" style="font-size: 1.1rem;">
                            ${emotion.service_signals.risk_level === 'normal' ? 'ğŸ˜Š ì •ìƒ' : 
                              emotion.service_signals.risk_level === 'watch' ? 'ğŸ‘€ ê´€ì°°' :
                              emotion.service_signals.risk_level === 'alert' ? 'âš ï¸ ì£¼ì˜' : 'ğŸš¨ ìœ„í—˜'}
                        </div>
                    </div>
                </div>

                ${secondary.length > 0 ? `
                <div style="margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #666;">ë³´ì¡° ê°ì •</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${secondary.map(em => `
                            <div style="padding: 8px 15px; background: white; border-radius: 20px; border: 1px solid #e0e0e0;">
                                ${em.name_ko} (ê°•ë„: ${em.intensity})
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="meta-info">
                    <div class="meta-item">
                        <span>ğŸ’¡</span>
                        <span><strong>ì¶”ì²œ ì‘ë‹µ:</strong> ${emotion.recommended_response_style[0]}</span>
                    </div>
                    <div class="meta-item">
                        <span>ğŸƒ</span>
                        <span><strong>ì¶”ì²œ ë£¨í‹´:</strong> ${emotion.recommended_routine_tags.join(', ')}</span>
                    </div>
                    <div class="meta-item">
                        <span>â±ï¸</span>
                        <span><strong>ë¶„ì„ ì‹œê°„:</strong> ${duration}ms</span>
                    </div>
                </div>
            `;
        }

        function displayRoutineResult(routines, duration) {
            const content = document.getElementById('routineContent');
            content.style.display = 'block';
            
            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #333;">ì¶”ì²œ ë£¨í‹´ (${routines.length}ê°œ)</div>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    ${routines.map((routine, index) => `
                        <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="font-weight: 600; font-size: 1.1rem; color: #333;">
                                    ${index + 1}. ${routine.title || 'N/A'}
                                </div>
                                <div style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85rem;">
                                    ìš°ì„ ìˆœìœ„ ${routine.priority || 'N/A'}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <span style="background: #f5f5f5; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; color: #666;">
                                    ${routine.category || 'N/A'}
                                </span>
                                ${routine.duration_min ? `
                                    <span style="background: #e3f2fd; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; color: #1976d2; margin-left: 5px;">
                                        â±ï¸ ${routine.duration_min}ë¶„
                                    </span>
                                ` : ''}
                                ${routine.intensity_level ? `
                                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; color: #f57c00; margin-left: 5px;">
                                        ğŸ’ª ${routine.intensity_level}
                                    </span>
                                ` : ''}
                            </div>
                            
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                                    <strong>ì¶”ì²œ ì´ìœ :</strong> ${routine.reason || 'N/A'}
                                </div>
                                <div style="color: #667eea; font-size: 0.95rem; font-weight: 500;">
                                    ğŸ’¬ ${routine.ui_message || 'N/A'}
                                </div>
                            </div>
                            
                            ${routine.suggested_time_window ? `
                                <div style="margin-top: 8px; font-size: 0.85rem; color: #999;">
                                    â° ì¶”ì²œ ì‹œê°„: ${routine.suggested_time_window}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                
                <div class="meta-info">
                    <div class="meta-item">
                        <span>â±ï¸</span>
                        <span><strong>ì¶”ì²œ ì‹œê°„:</strong> ${duration}ms</span>
                    </div>
                </div>
            `;
        }

        function displayLLMResult(result, duration) {
            const content = document.getElementById('llmContent');
            content.style.display = 'block';
            
            // ì „ì²´ ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
            const totalTime = timers.stt.end - timers.stt.start + 
                            timers.emotion.end - timers.emotion.start + 
                            (timers.routine.end - timers.routine.start) +
                            timers.llm.end - timers.llm.start;
            
            content.innerHTML = `
                <div class="ai-response">
                    <div class="ai-response-label">ğŸŒ¸ AI ë´„ì´ì˜ ì‘ë‹µ</div>
                    <div class="ai-response-text">${result.reply_text}</div>
                </div>

                <div class="meta-info">
                    <div class="meta-item">
                        <span>ğŸ¤–</span>
                        <span><strong>ëª¨ë¸:</strong> ${result.meta.model}</span>
                    </div>
                    <div class="meta-item">
                        <span>ğŸ”§</span>
                        <span><strong>ì‚¬ìš©ëœ ë„êµ¬:</strong> ${result.meta.used_tools.join(', ')}</span>
                    </div>
                    <div class="meta-item">
                        <span>â±ï¸</span>
                        <span><strong>ì‘ë‹µ ìƒì„±:</strong> ${duration}ms</span>
                    </div>
                    <div class="meta-item">
                        <span>â°</span>
                        <span><strong>ì „ì²´ ì‹œê°„:</strong> ${Math.round(totalTime)}ms</span>
                    </div>
                    <div class="meta-item">
                        <span>ğŸ†”</span>
                        <span><strong>ì„¸ì…˜:</strong> ${result.meta.session_id}</span>
                    </div>
                </div>
            `;
        }

        async function callTTS(text) {
            timers.tts.start = performance.now();
            updateToolStatus('tts', 'processing', 'ìŒì„± ìƒì„± ì¤‘...');
            
            try {
                const response = await fetch('http://localhost:8000/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        tone: 'senior_calm',
                        engine: 'melo'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Blobìœ¼ë¡œ ì˜¤ë””ì˜¤ ë°ì´í„° ë°›ê¸°
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                timers.tts.end = performance.now();
                const duration = Math.round(timers.tts.end - timers.tts.start);
                
                updateToolStatus('tts', 'success', 'ì™„ë£Œ', duration);
                displayTTSResult(audioUrl, duration);
                
                // ìë™ ì¬ìƒ
                const audio = new Audio(audioUrl);
                audio.play().catch(err => {
                    console.error('ìë™ ì¬ìƒ ì‹¤íŒ¨:', err);
                });
                
            } catch (error) {
                console.error('TTS ì˜¤ë¥˜:', error);
                updateToolStatus('tts', 'error', 'ì˜¤ë¥˜');
                const content = document.getElementById('ttsContent');
                content.style.display = 'block';
                content.innerHTML = `
                    <div style="color: #d32f2f; padding: 10px;">
                        <strong>ì˜¤ë¥˜:</strong> ${error.message}
                    </div>
                `;
                throw error;
            }
        }

        function displayTTSResult(audioUrl, duration) {
            const content = document.getElementById('ttsContent');
            content.style.display = 'block';
            
            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ”Š ìŒì„± ì¬ìƒ</strong>
                    <div style="margin-top: 10px;">
                        <audio controls style="width: 100%; max-width: 500px;">
                            <source src="${audioUrl}" type="audio/wav">
                            ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </audio>
                    </div>
                </div>

                <div class="meta-info">
                    <div class="meta-item">
                        <span>ğŸµ</span>
                        <span><strong>ì—”ì§„:</strong> MeloTTS (Korean)</span>
                    </div>
                    <div class="meta-item">
                        <span>ğŸ­</span>
                        <span><strong>í†¤:</strong> senior_calm (ê°±ë…„ê¸° ì–´ë¨¸ë‹ˆ ìƒë‹´ í†¤)</span>
                    </div>
                    <div class="meta-item">
                        <span>â±ï¸</span>
                        <span><strong>ìƒì„± ì‹œê°„:</strong> ${duration}ms</span>
                    </div>
                    <div class="meta-item">
                        <span>ğŸ“</span>
                        <span><strong>ìƒíƒœ:</strong> ìë™ ì¬ìƒ ì‹œì‘ë¨</span>
                    </div>
                </div>
            `;
        }

        function resetToolCards() {
            ['stt', 'emotion', 'routine', 'llm', 'tts'].forEach(tool => {
                updateToolStatus(tool, 'pending', 'ëŒ€ê¸° ì¤‘', null);
                document.getElementById(`${tool}Content`).style.display = 'none';
                timers[tool] = { start: 0, end: 0 };
            });
        }

        function clearResults() {
            document.getElementById('userInput').value = '';
            document.getElementById('pipelineSection').style.display = 'none';
            currentSessionId = 'web_session_' + Date.now();
            
            // ìŒì„± ì…ë ¥ ì´ˆê¸°í™”
            recognizedFullText = '';
            document.getElementById('recognizedText').style.display = 'none';
            document.getElementById('recognizedTextContent').textContent = '';
            if (isRecording) {
                stopVoiceInput();
            }
            updateVoiceStatus('ë§ˆì´í¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë…¹ìŒì„ ì‹œì‘í•˜ì„¸ìš”', 'idle');
        }

        async function loadMemory() {
            const memorySection = document.getElementById('memorySection');
            const memoryContent = document.getElementById('memoryContent');
            
            memorySection.style.display = 'block';
            memoryContent.innerHTML = '<div style="text-align: center; padding: 20px;">ë¡œë”© ì¤‘...</div>';
            
            try {
                const response = await fetch(`http://localhost:8000/api/agent/memory/${currentSessionId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayMemory(data);
                
            } catch (error) {
                console.error('Error loading memory:', error);
                memoryContent.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef5350;">
                        âŒ ë©”ëª¨ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                    </div>
                `;
            }
        }

        function displayMemory(data) {
            const memoryContent = document.getElementById('memoryContent');
            
            if (data.message_count === 0) {
                memoryContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        í˜„ì¬ ì„¸ì…˜ì— ì €ì¥ëœ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <strong>ì„¸ì…˜ ID:</strong> ${data.session_id}<br>
                    <strong>ë©”ì‹œì§€ ê°œìˆ˜:</strong> ${data.message_count}ê°œ
                </div>
            `;
            
            data.messages.forEach((msg, index) => {
                const isUser = msg.role === 'user';
                const bgColor = isUser ? '#e3f2fd' : '#f3e5f5';
                const icon = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
                const roleName = isUser ? 'ì‚¬ìš©ì' : 'AI ë´„ì´';
                
                html += `
                    <div style="margin-bottom: 15px; padding: 15px; background: ${bgColor}; border-radius: 10px; border-left: 4px solid ${isUser ? '#2196f3' : '#9c27b0'};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>${icon} ${roleName}</strong>
                            <span style="color: #666; font-size: 0.85rem;">${new Date(msg.timestamp).toLocaleString('ko-KR')}</span>
                        </div>
                        <div style="line-height: 1.6;">${msg.content}</div>
                        ${msg.metadata ? `
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #666; font-size: 0.85rem;">ğŸ“Š ë©”íƒ€ë°ì´í„° ë³´ê¸°</summary>
                                <pre style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 0.8rem; overflow-x: auto;">${JSON.stringify(msg.metadata, null, 2)}</pre>
                            </details>
                        ` : ''}
                    </div>
                `;
            });
            
            memoryContent.innerHTML = html;
        }
    </script>
</body>
</html>

